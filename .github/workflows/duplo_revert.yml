name: duplo revert

on:
  workflow_dispatch:
    inputs:
      git_hub_sha:
        required: true

env:
  duplo_token: "${{ secrets.DUPLO_TOKEN }}"
  duplo_host: https://test01.duplocloud.net  # CHANGE ME!
  cloudfront_distribution_id: E1QGIWKA2DZY0A  # CHANGE ME!
  duplo_tenant: raghavan01  # CHANGE ME!
  api_url: https://api_url # CHANGE ME!
  app_url: https://app_url # CHANGE ME!
  aws_region: us-east-1 # CHANGE ME!
  cloudfront_origin_id: duploservices-raghavan01-s3app1-386269687991.s3.us-east-1.amazonaws.com

jobs:
  revert-to-previous:
    name: Deploy to staging
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: AWS just-in-time access
        uses: duplocloud/ghactions-aws-jit@master
        with:
          duplo_host: ${{ env.duplo_host }}
          duplo_token: "${{ env.duplo_token }}"
          tenant: ${{ env.duplo_tenant }}

      - name: Cloud Front revert
        run: |-
          NEW_ORIGIN_PATH=/${{ inputs.git_hub_sha }}
          DIST_CONFIG_OLD_FILENAME="dist-config.json"
          DIST_CONFIG_NEW_FILENAME="dist-config2.json"
          aws cloudfront get-distribution --id ${{env.cloudfront_distribution_id}} > $DIST_CONFIG_OLD_FILENAME
          Etag=`cat $DIST_CONFIG_OLD_FILENAME | jq '.ETag' | tr -d \"`
          cat $DIST_CONFIG_OLD_FILENAME | jq --arg targetOriginId ${{ env.cloudfront_origin_id }} --arg newOriginPath $NEW_ORIGIN_PATH '.Distribution.DistributionConfig | .Origins.Items = (.Origins.Items | map(if (.Id == $targetOriginId) then (.OriginPath = $newOriginPath) else . end))' > $DIST_CONFIG_NEW_FILENAME
          aws cloudfront update-distribution --id ${{env.cloudfront_distribution_id}} --distribution-config "file://${DIST_CONFIG_NEW_FILENAME}" --if-match $Etag > /dev/null
          rm -f $DIST_CONFIG_OLD_FILENAME $DIST_CONFIG_NEW_FILENAME

      - name: Invalidate Cloudfront
        uses: chetan/invalidate-cloudfront-action@v2
        env:
          DISTRIBUTION: '${{ env.cloudfront_distribution_id }}'
          PATHS: '/*'
